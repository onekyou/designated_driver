현재 시스템은 콜디텍터에 새로운 콜이 뜨면 전화기에 저장된 정보를 바탕으로 문서를 작성해 파이어베이스에 업데이트하고
콜매니저에서 정보를 다운받아 기사앱에 정보를 전달, 운행을 준비 및 도착지, 운행료를 기입후 운행과 운행완료를 콜매니저에 전달하는 구조야

*기본로직
콜발생(핸드폰수락버튼클릭)시 콜매니저에 알림과 배차팝업 생성, 배차팝업의 기사선택 클릭
기사앱에 알림과 수락버튼 생성, 수락후 출발 도착 운행요금 기입 후 운행버시작버튼 클릭

콜매니저에 알림과 더불어 운행시작 알림 팝업(고객명 출발비 도착지 요금)생성

기사앱 운행관리의 완료버튼 클릭시 운행완료요약팝업생성 결재방법을 선택후 확인
콜매니저에 운행완료알림팝업데이터 구조 요약
전체 데이터는 여러 개의 최상위 컬렉션으로 구성되어 있으며, 각 컬렉션은 다시 하위 컬렉션과 문서(Document)들을 포함하는 계층적인 구조를 가지고 있습니다.
1. admins 컬렉션
관리자 정보를 담고 있습니다. 각 관리자 문서는 고유 ID를 가지며, 다음과 같은 필드로 구성됩니다.
createdAt: 계정 생성 타임스탬프
name: 관리자 이름
associatedRegionId: 소속 지역 ID (예: "yangpyong")
associatedOfficeId: 소속 사무실 ID (예: "office_1")
email: 이메일 주소
2. pending_drivers 컬렉션
가입 승인 대기 중인 기사 정보를 담는 것으로 보입니다. 현재는 필드가 비어있습니다.
name, phoneNumber, targetRegionId, targetOfficeId
3. regions 컬렉션
운행 지역 정보를 관리합니다. 현재 "Hongchon"(홍천군), "yangpyong"(양평군) 두 개의 지역이 있습니다.
각 지역 문서는 name(지역명)과 offices 라는 하위 컬렉션을 가집니다.
4. offices 하위 컬렉션
각 지역에 속한 대리운전 사무실 정보를 관리합니다. (예: "vip대리운전", "조은대리")
각 사무실 문서는 name(사무실명)과 여러 하위 컬렉션을 가집니다.
calls 컬렉션: 가장 핵심적인 데이터로, 고객의 호출 정보를 담습니다.
phoneNumber: 고객 전화번호
customerName: 고객 이름
customerAddress: 고객 주소 (있는 경우)
status: 호출 상태 ("대기중", "배정됨", "완료", "보류")
detectedTimestamp: 호출 감지 시간
assignedDriverId, assignedDriverName: 배정된 대리 기사 정보
trip_summary, departure_set, destination_set, fare_set: 운행 완료 후 기록되는 출발지, 도착지, 요금 등의 운행 정보
designated_drivers 컬렉션: 소속된 대리 기사 목록입니다.
name: 기사 이름
phoneNumber: 전화번호
driverType: 기사 유형 ("대리기사")
status: 현재 상태 ("대기중", "오프라인")
pickup_drivers 컬렉션: 소속된 픽업 기사 목록으로 보입니다.
결론 및 추가 제안
분석 결과, 이 데이터는 지역(Region) -> 사무실(Office) -> [호출(Calls), 대리기사, 픽업기사] 로 이어지는 명확한 계층 구조를 가지고 있습니다. CallDetector라는 이름에서 유추했듯이, 핵심 기능은 calls 컬렉션에 고객의 전화 수신 기록을 저장하고, 이 호출을 기사에게 배정하며 상태를 추적하는 것입니다.

파이어스토어 규칙rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isOfficeAdmin(regionId, officeId) {
      let adminDocPath = /databases/$(database)/documents/admins/$(request.auth.uid);
      return request.auth != null
             && exists(adminDocPath)
             && get(adminDocPath).data.associatedRegionId == regionId
             && get(adminDocPath).data.associatedOfficeId == officeId;
    }
    // --- Helper Functions End ---

    // 관리자 문서 규칙 (/admins/{adminId})
    match /admins/{adminId} {
      allow read, write: if request.auth != null && request.auth.uid == adminId;
    }

    // 보류 중인 드라이버 규칙 (/pending_drivers/{userId})
    match /pending_drivers/{userId} {
      allow create: if request.auth != null && request.auth.uid == userId;
      allow read: if request.auth != null &&
                     (exists(/databases/$(database)/documents/admins/$(request.auth.uid))
                      || request.auth.uid == userId);
      allow delete: if request.auth != null && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    // 컬렉션 그룹 규칙 (designated_drivers 읽기용)
    // 로그인 시 자신의 기사 정보를 찾기 위해 필요합니다.
    match /{path=**}/designated_drivers/{driverId} {
      allow read: if request.auth != null && resource.data.authUid == request.auth.uid;
    }

    // 지역 및 사무실 데이터 규칙
    match /regions/{regionId} {
      allow read: if true; 

      match /offices/{officeId} {
        allow read: if true; 

        // 기사 정보 규칙
        match /designated_drivers/{driverId} {
          allow read: if isOfficeAdmin(regionId, officeId)
                       || (request.auth != null && request.auth.uid == driverId); 
          allow create: if isOfficeAdmin(regionId, officeId); 
          // 관리자 또는 본인만 업데이트/삭제 가능
          allow update, delete: if isOfficeAdmin(regionId, officeId) 
                         || (request.auth != null && request.auth.uid == driverId); 
        }
        
        match /calls/{callId=**} { 
          allow list: if request.auth != null; 
        }

        // 콜 정보 규칙
        match /calls/{callId} {
          allow read: if isOfficeAdmin(regionId, officeId) ||
                         (request.auth != null && request.auth.uid == resource.data.assignedDriverId); 

          allow create: if true; // ★보안 강화 필요: 실제로는 관리자 또는 특정 앱에서만 생성하도록 제한해야 합니다.

          // ★★★ 수정된 업데이트 규칙 ★★★
          allow update: if isOfficeAdmin(regionId, officeId) 
            || (
              request.auth != null
              && request.auth.uid == resource.data.assignedDriverId 
              && (
                // 조건 1: 콜 수락 ('ASSIGNED' -> 'ACCEPTED'). acceptCall 함수에 해당
                (
                  resource.data.status == "ASSIGNED" &&
                  request.resource.data.status == "ACCEPTED" &&
                  // acceptCall 함수는 현재 status만 변경하므로, 다른 필드 변경은 허용하지 않음
                  request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status'])
                ) ||
                // 조건 2: 운행 시작 ('ACCEPTED' -> 'INPROGRESS'). startDriving 함수에 해당
                (
                  resource.data.status == "ACCEPTED" &&
                  request.resource.data.status == "INPROGRESS" &&
                  request.resource.data.diff(resource.data).affectedKeys().hasAll([
                    'status', 'departure_set', 'destination_set', 'waypoints_set', 'fare_set', 'trip_summary', 'updatedAt'
                  ]) &&
                  request.resource.data.diff(resource.data).affectedKeys().size() == 7
                ) ||
                // 조건 3: 운행 완료 처리 ('INPROGRESS' -> 'AWAITING_SETTLEMENT'). completeCall 함수에 해당
                (
                  resource.data.status == "INPROGRESS" &&
                  request.resource.data.status == "AWAITING_SETTLEMENT" &&
                  request.resource.data.diff(resource.data).affectedKeys().hasAll(['status', 'updatedAt']) &&
                  request.resource.data.diff(resource.data).affectedKeys().size() == 2
                ) ||
                // 조건 4: 최종 정산 ('AWAITING_SETTLEMENT' -> 'COMPLETED'). confirmAndFinalizeTrip 함수에 해당
                (
                  resource.data.status == "AWAITING_SETTLEMENT" &&
                  request.resource.data.status == "COMPLETED" &&
                  request.resource.data.isSummaryConfirmed == true &&
                  (
                    // 시나리오 1: cashAmount가 업데이트에 포함되지 않을 때 (카드, 포인트 등)
                    (
                      !request.resource.data.diff(resource.data).affectedKeys().has('cashAmount') &&
                      request.resource.data.diff(resource.data).affectedKeys().hasAll([
                        'status', 'paymentMethod', 'fare', 'trip_summary',
                        'isSummaryConfirmed', 'summaryConfirmedTimestamp', 'updatedAt'
                      ]) &&
                      request.resource.data.diff(resource.data).affectedKeys().size() == 7
                    ) ||
                    // 시나리오 2: cashAmount가 업데이트에 포함될 때 (현금+포인트)
                    (
                      request.resource.data.paymentMethod == "현금+포인트" &&
                      request.resource.data.diff(resource.data).affectedKeys().hasAll([
                        'status', 'paymentMethod', 'fare', 'cashAmount', 'trip_summary',
                        'isSummaryConfirmed', 'summaryConfirmedTimestamp', 'updatedAt'
                      ]) &&
                      request.resource.data.diff(resource.data).affectedKeys().size() == 8
                    )
                  )
                )
              )
            );

          allow delete: if isOfficeAdmin(regionId, officeId); 
        }
      }
    }

    // 공유 콜 규칙 (읽기만 허용)
    match /shared_calls/{sharedCallId} {
      allow read: if request.auth != null; 
      // ★ 참고: 공유 콜을 가져가는(claim) 로직을 추가하려면 여기에 update 규칙이 필요합니다.
    }
  }
} C 드라이브의 볼륨: OS
 볼륨 일련 번호: C0F4-4F7D

 C:\app_dev\designated_driver\driver_app\app\src\main\java\com\designated\driverapp 디렉터리

2025-06-09  오후 04:06    <DIR>          .
2025-06-07  오후 11:54    <DIR>          ..
2025-06-09  오후 04:06    <DIR>          data
2025-06-07  오후 11:54    <DIR>          di
2025-06-08  오전 12:00               567 DriverApplication.kt
2025-06-09  오후 04:46             6,648 MainActivity.kt
2025-06-07  오후 11:54    <DIR>          model
2025-05-18  오전 03:24             2,146 MyFirebaseMessagingService.kt
2025-06-08  오전 12:00    <DIR>          navigation
2025-06-07  오후 11:54    <DIR>          service
2025-06-07  오후 11:54    <DIR>          ui
2025-04-17  오후 04:04    <DIR>          viewmodel
               3개 파일               9,361 바이트

 C:\app_dev\designated_driver\driver_app\app\src\main\java\com\designated\driverapp\data 디렉터리

2025-06-09  오후 04:06    <DIR>          .
2025-06-09  오후 04:06    <DIR>          ..
2025-06-09  오후 06:34             1,817 Constants.kt
               1개 파일               1,817 바이트

 C:\app_dev\designated_driver\driver_app\app\src\main\java\com\designated\driverapp\di 디렉터리

2025-06-07  오후 11:54    <DIR>          .
2025-06-09  오후 04:06    <DIR>          ..
2025-06-02  오전 12:53             1,160 AppModule.kt
               1개 파일               1,160 바이트

 C:\app_dev\designated_driver\driver_app\app\src\main\java\com\designated\driverapp\model 디렉터리

2025-06-07  오후 11:54    <DIR>          .
2025-06-09  오후 04:06    <DIR>          ..
2025-06-09  오후 04:18             1,390 CallStatus.kt
2025-06-09  오후 04:15             2,898 DriverModel.kt
               2개 파일               4,288 바이트

 C:\app_dev\designated_driver\driver_app\app\src\main\java\com\designated\driverapp\navigation 디렉터리

2025-06-08  오전 12:00    <DIR>          .
2025-06-09  오후 04:06    <DIR>          ..
2025-06-09  오후 05:44             3,306 AppNavigation.kt
               1개 파일               3,306 바이트

 C:\app_dev\designated_driver\driver_app\app\src\main\java\com\designated\driverapp\service 디렉터리

2025-06-07  오후 11:54    <DIR>          .
2025-06-09  오후 04:06    <DIR>          ..
2025-06-09  오후 05:13            19,543 DriverForegroundService.kt
               1개 파일              19,543 바이트

 C:\app_dev\designated_driver\driver_app\app\src\main\java\com\designated\driverapp\ui 디렉터리

2025-06-07  오후 11:54    <DIR>          .
2025-06-09  오후 04:06    <DIR>          ..
2025-04-17  오후 04:04    <DIR>          dashboard
2025-06-09  오후 05:29    <DIR>          home
2025-06-07  오후 11:54    <DIR>          login
2025-06-07  오후 11:54    <DIR>          theme
               0개 파일                   0 바이트

 C:\app_dev\designated_driver\driver_app\app\src\main\java\com\designated\driverapp\ui\dashboard 디렉터리

2025-04-17  오후 04:04    <DIR>          .
2025-06-07  오후 11:54    <DIR>          ..
               0개 파일                   0 바이트

 C:\app_dev\designated_driver\driver_app\app\src\main\java\com\designated\driverapp\ui\home 디렉터리

2025-06-09  오후 05:29    <DIR>          .
2025-06-07  오후 11:54    <DIR>          ..
2025-06-09  오후 04:56             4,584 DriverAppUtils.kt
2025-06-09  오후 05:44            26,208 HistorySettlementScreen.kt
2025-06-09  오후 05:31            37,979 HomeScreen.kt
               3개 파일              68,771 바이트

 C:\app_dev\designated_driver\driver_app\app\src\main\java\com\designated\driverapp\ui\login 디렉터리

2025-06-07  오후 11:54    <DIR>          .
2025-06-07  오후 11:54    <DIR>          ..
2025-04-17  오전 02:37             8,827 ForgotPasswordScreen.kt
2025-06-06  오전 12:34             8,282 LoginScreen.kt
2025-06-06  오전 03:37            13,565 LoginViewModel.kt
2025-04-30  오전 01:11            11,286 SignUpScreen.kt
2025-05-01  오전 04:15            10,728 SignUpViewModel.kt
               5개 파일              52,688 바이트

 C:\app_dev\designated_driver\driver_app\app\src\main\java\com\designated\driverapp\ui\theme 디렉터리

2025-06-07  오후 11:54    <DIR>          .
2025-06-07  오후 11:54    <DIR>          ..
2025-04-23  오후 03:02             1,265 Color.kt
2025-04-23  오후 03:03             3,725 Theme.kt
2025-04-16  오후 07:38             1,286 Type.kt
               3개 파일               6,276 바이트

 C:\app_dev\designated_driver\driver_app\app\src\main\java\com\designated\driverapp\viewmodel 디렉터리

2025-04-17  오후 04:04    <DIR>          .
2025-06-09  오후 04:06    <DIR>          ..
               0개 파일                   0 바이트

     전체 파일:
              20개 파일             167,210 바이트
              35개 디렉터리  309,613,809,664 바이트 남음
 C 드라이브의 볼륨: OS
 볼륨 일련 번호: C0F4-4F7D

 C:\app_dev\designated_driver\call_manager\app\src\main\java\com\designated\callmanager 디렉터리

2025-06-07  오후 11:55    <DIR>          .
2025-06-07  오후 11:55    <DIR>          ..
2025-06-09  오후 09:23    <DIR>          data
2025-06-09  오후 09:43            32,171 MainActivity.kt
2025-06-07  오후 11:55    <DIR>          receiver
2025-06-07  오후 11:55    <DIR>          service
2025-06-07  오후 11:55    <DIR>          ui
               1개 파일              32,171 바이트

 C:\app_dev\designated_driver\call_manager\app\src\main\java\com\designated\callmanager\data 디렉터리

2025-06-09  오후 09:23    <DIR>          .
2025-06-07  오후 11:55    <DIR>          ..
2025-06-09  오후 06:38             3,144 CallInfo.kt
2025-06-09  오후 09:21               573 CallStatus.kt
2025-06-09  오후 07:10             2,028 Constants.kt
2025-06-09  오후 06:45             2,183 DriverInfo.kt
2025-06-09  오후 11:03               692 DriverStatus.kt
2025-04-30  오전 01:47               162 OfficeItem.kt
2025-04-30  오후 10:43               716 PendingDriverInfo.kt
2025-04-29  오후 03:35               248 README.md
2025-04-30  오전 01:47               162 RegionItem.kt
2025-06-09  오후 07:12               291 SettlementData.kt
              10개 파일              10,199 바이트

 C:\app_dev\designated_driver\call_manager\app\src\main\java\com\designated\callmanager\receiver 디렉터리

2025-06-07  오후 11:55    <DIR>          .
2025-06-07  오후 11:55    <DIR>          ..
2025-04-15  오후 10:18             1,706 BootReceiver.kt
               1개 파일               1,706 바이트

 C:\app_dev\designated_driver\call_manager\app\src\main\java\com\designated\callmanager\service 디렉터리

2025-06-07  오후 11:55    <DIR>          .
2025-06-07  오후 11:55    <DIR>          ..
2025-06-09  오후 09:53            14,147 CallManagerService.kt
               1개 파일              14,147 바이트

 C:\app_dev\designated_driver\call_manager\app\src\main\java\com\designated\callmanager\ui 디렉터리

2025-06-07  오후 11:55    <DIR>          .
2025-06-07  오후 11:55    <DIR>          ..
2025-06-09  오후 09:42    <DIR>          dashboard
2025-06-09  오후 06:58    <DIR>          drivermanagement
2025-06-09  오후 09:05    <DIR>          login
2025-06-07  오후 11:55    <DIR>          main
2025-06-07  오후 11:55    <DIR>          navigation
2025-06-07  오후 11:55    <DIR>          pendingdrivers
2025-06-07  오후 11:55    <DIR>          popup
2025-06-07  오후 11:55    <DIR>          settings
2025-06-09  오후 06:50    <DIR>          settlement
2025-06-07  오후 11:55    <DIR>          signup
2025-06-07  오후 11:55    <DIR>          theme
               0개 파일                   0 바이트

 C:\app_dev\designated_driver\call_manager\app\src\main\java\com\designated\callmanager\ui\dashboard 디렉터리

2025-06-09  오후 09:42    <DIR>          .
2025-06-07  오후 11:55    <DIR>          ..
2025-06-09  오후 09:42            19,967 DashboardScreen.kt
2025-06-09  오후 11:03            17,454 DashboardViewModel.kt
               2개 파일              37,421 바이트

 C:\app_dev\designated_driver\call_manager\app\src\main\java\com\designated\callmanager\ui\drivermanagement 디렉터리

2025-06-09  오후 06:58    <DIR>          .
2025-06-07  오후 11:55    <DIR>          ..
2025-06-09  오후 08:08             5,365 DriverManagementScreen.kt
2025-06-09  오후 06:58             3,691 DriverManagementViewModel.kt
               2개 파일               9,056 바이트

 C:\app_dev\designated_driver\call_manager\app\src\main\java\com\designated\callmanager\ui\login 디렉터리

2025-06-09  오후 09:05    <DIR>          .
2025-06-07  오후 11:55    <DIR>          ..
2025-06-09  오후 09:05             7,245 LoginScreen.kt
2025-06-09  오후 09:03             9,041 LoginViewModel.kt
               2개 파일              16,286 바이트

 C:\app_dev\designated_driver\call_manager\app\src\main\java\com\designated\callmanager\ui\main 디렉터리

2025-06-07  오후 11:55    <DIR>          .
2025-06-07  오후 11:55    <DIR>          ..
2025-04-30  오전 01:26             1,170 MainDashboardScreen.kt
               1개 파일               1,170 바이트

 C:\app_dev\designated_driver\call_manager\app\src\main\java\com\designated\callmanager\ui\navigation 디렉터리

2025-06-07  오후 11:55    <DIR>          .
2025-06-07  오후 11:55    <DIR>          ..
2025-05-01  오전 05:49             2,548 NavGraph.kt
               1개 파일               2,548 바이트

 C:\app_dev\designated_driver\call_manager\app\src\main\java\com\designated\callmanager\ui\pendingdrivers 디렉터리

2025-06-07  오후 11:55    <DIR>          .
2025-06-07  오후 11:55    <DIR>          ..
2025-04-30  오후 11:13             9,130 PendingDriversScreen.kt
2025-06-09  오후 08:11            10,234 PendingDriversViewModel.kt
               2개 파일              19,364 바이트

 C:\app_dev\designated_driver\call_manager\app\src\main\java\com\designated\callmanager\ui\popup 디렉터리

2025-06-07  오후 11:55    <DIR>          .
2025-06-07  오후 11:55    <DIR>          ..
2025-04-29  오후 08:14             3,911 CallOverlayActivity.kt
2025-04-29  오후 08:14             2,095 RequestOverlayPermissionActivity.kt
               2개 파일               6,006 바이트

 C:\app_dev\designated_driver\call_manager\app\src\main\java\com\designated\callmanager\ui\settings 디렉터리

2025-06-07  오후 11:55    <DIR>          .
2025-06-07  오후 11:55    <DIR>          ..
2025-06-09  오후 09:25             6,556 SettingsScreen.kt
2025-04-29  오전 05:14             2,602 SettingsViewModel.kt
               2개 파일               9,158 바이트

 C:\app_dev\designated_driver\call_manager\app\src\main\java\com\designated\callmanager\ui\settlement 디렉터리

2025-06-09  오후 06:50    <DIR>          .
2025-06-07  오후 11:55    <DIR>          ..
2025-06-09  오후 08:11             9,683 SettlementScreen.kt
2025-06-09  오후 07:09             2,811 SettlementViewModel.kt
               2개 파일              12,494 바이트

 C:\app_dev\designated_driver\call_manager\app\src\main\java\com\designated\callmanager\ui\signup 디렉터리

2025-06-07  오후 11:55    <DIR>          .
2025-06-07  오후 11:55    <DIR>          ..
2025-04-29  오전 04:18            11,959 SignUpScreen.kt
2025-04-29  오전 03:40            10,279 SignUpViewModel.kt
               2개 파일              22,238 바이트

 C:\app_dev\designated_driver\call_manager\app\src\main\java\com\designated\callmanager\ui\theme 디렉터리

2025-06-07  오후 11:55    <DIR>          .
2025-06-07  오후 11:55    <DIR>          ..
2025-04-15  오후 05:02               909 Color.kt
2025-04-17  오전 05:40             2,711 Theme.kt
2025-04-08  오전 06:07             1,029 Type.kt
               3개 파일               4,649 바이트

     전체 파일:
              34개 파일             198,613 바이트
              47개 디렉터리  308,329,684,992 바이트 남음
