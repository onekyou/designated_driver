콜매니저앱(call_manager) 점검 결과
● Firestore 리스너 의존 코드
CallManagerService.kt
setupCallListener()에서 콜 컬렉션에 addSnapshotListener로 실시간 감시
콜 추가/변경/삭제 시 MainActivity로 Intent 전송 및 팝업/알림 처리
아직도 알림/팝업의 핵심 트리거가 리스너에 의존
DashboardViewModel.kt
callsListener, driversListener, officeStatusListener 등 Firestore 리스너로 실시간 데이터 감시 및 UI 갱신
콜 상태 변화 시 팝업/알림 StateFlow 값 변경
● 상수 일관성
상태값, 필드명 등 영문으로 통일됨
콜 상태값 일부(INPROGRESS vs IN_PROGRESS) 오타/불일치 가능성 있음(서로 맞춰야 함)
FCM 토큰 필드는 없음(관리자 FCM 알림 수신 로직은 별도 구현 필요)
2. 기사앱(driver_app) 점검 결과
● FCM(토큰) 기반 알림
MyFirebaseMessagingService.kt
FCM 수신 시 showNotification으로 로컬 알림 생성
onNewToken에서 Firestore에 토큰 저장(상수명 일치)
LoginViewModel, LoginScreen
로그인 시 토큰 비교 후 필요시 Firestore에 저장
● Firestore 리스너
DriverForegroundService.kt
기사 상태, 배정 콜 실시간 감시(화면 갱신용)
알림(Notification)은 FCM으로만 처리, UI 실시간성은 리스너 유지
Constants.kt
상태값, 필드명, 토큰 필드 등 영문으로 통일
콜 상태값 IN_PROGRESS 등 일관성 있음
3. 남은 개선 포인트 및 권장 방향
● 콜매니저앱
알림/팝업 트리거를 Firestore 리스너 → FCM 기반으로 완전 전환 필요
예: 기사 운행 시작/완료 시 Functions에서 관리자 FCM 토큰으로 푸시 발송
리스너는 UI 실시간 갱신(리스트, 상태 등)만 담당
상수 오타/불일치(INPROGRESS vs IN_PROGRESS) 반드시 통일
● 기사앱
FCM 기반 알림 구조 완성, 리스너는 UI 실시간 갱신용으로만 남겨도 무방
4. 전체 구조 요약
FCM(토큰) 기반 알림:
기사앱: 콜 배정/상태 변경 → FCM 알림 100% 전환 완료
콜매니저앱: 기사 운행 시작/완료 등 → FCM 알림 전환 필요(Functions/FCM 연동)
Firestore 리스너:
UI 실시간 갱신(리스트, 상태 등) 용도로만 남기고, 알림/팝업은 FCM으로 통일하는 것이 목표