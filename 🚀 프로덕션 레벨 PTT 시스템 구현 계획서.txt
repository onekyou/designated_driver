ğŸš€ í”„ë¡œë•ì…˜ ë ˆë²¨ PTT ì‹œìŠ¤í…œ êµ¬í˜„ ê³„íšì„œ

  ğŸ“‹ ë¬¸ì„œ ì •ë³´

  | í•­ëª©     | ë‚´ìš©                                                        |
  |--------|-----------------------------------------------------------|
  | ë¬¸ì„œëª…    | í”„ë¡œë•ì…˜ ë ˆë²¨ PTT (Push-to-Talk) ì‹œìŠ¤í…œ êµ¬í˜„ ê³„íšì„œ                     |
  | ë²„ì „     | v1.0                                                      |
  | ì‘ì„±ì¼    | 2025-01-17                                                |
  | ëŒ€ìƒ ì‹œìŠ¤í…œ | ì½œë§¤ë‹ˆì € & í”½ì—…ì•± í†µí•© PTT ì‹œìŠ¤í…œ                                     |
  | ê¸°ìˆ  ìŠ¤íƒ  | Firebase RTDB, Agora SDK, Android Kotlin, Jetpack Compose |

  ---
  ğŸ¯ 1. í”„ë¡œì íŠ¸ ê°œìš”

  1.1 í˜„ì¬ ë¬¸ì œì 

  - ê° ì•±ì´ ê°œë³„ì ìœ¼ë¡œ PTT ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ë§Œ ì±„ë„ ì°¸ì—¬ ê°€ëŠ¥
  - í•œìª½ì—ì„œ ì†¡ì‹ ì„ ì‹œì‘í•´ë„ ë‹¤ë¥¸ ì•±ë“¤ì´ ìë™ìœ¼ë¡œ ìˆ˜ì‹  ëŒ€ê¸° ìƒíƒœê°€ ë˜ì§€ ì•ŠìŒ
  - ì‹¤ì‹œê°„ í†µì‹ ì„ ìœ„í•œ ë™ê¸°í™” ë©”ì»¤ë‹ˆì¦˜ ë¶€ì¬

  1.2 ëª©í‘œ ì‹œìŠ¤í…œ

  ì½œë§¤ë‹ˆì €ì—ì„œ PTT ë²„íŠ¼ í´ë¦­ â†’ ê°™ì€ ì‚¬ë¬´ì‹¤ì˜ ëª¨ë“  ì•±(í”½ì—…ì•± ë“±)ì´ ìë™ìœ¼ë¡œ ì±„ë„ ì°¸ì—¬í•˜ì—¬ ìˆ˜ì‹ 
  ëŒ€ê¸°

  1.3 í•µì‹¬ ìš”êµ¬ì‚¬í•­

  - 99.99% ë°ì´í„° ì •í•©ì„±: 3ì¤‘ ì•ˆì „ì¥ì¹˜ë¡œ ì™„ë²½í•œ ì„¸ì…˜ ê´€ë¦¬
  - ìš´ì „ì ì¤‘ì‹¬ UX: ì‹œê°/ì²­ê°/í–…í‹± í”¼ë“œë°±ìœ¼ë¡œ ì•ˆì „í•œ ìš´ì „ ì§€ì›
  - ë¬´ì œí•œ í™•ì¥ì„±: ëŒ€ê·œëª¨ ì‚¬ë¬´ì‹¤ ë° ë‹¤ì¤‘ ì•± ì§€ì›
  - ì‹¤ì‹œê°„ ë™ê¸°í™”: 100ms ì´ë‚´ ì‘ë‹µì†ë„ ë³´ì¥

  ---
  ğŸ—ï¸ 2. ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

  2.1 ê°œì„ ëœ ë°ì´í„° ëª¨ë¸

  // Firebase Realtime Database êµ¬ì¡°
  /ptt_sessions/{regionId}_{officeId}/
    â”œâ”€â”€ active: true/false                    // ì„¸ì…˜ í™œì„± ì—¬ë¶€
    â”œâ”€â”€ channel_name: "yangpyong_office_ptt"  // PTT ì±„ë„ ì´ë¦„
    â”œâ”€â”€ started_at: timestamp                 // ì„¸ì…˜ ì‹œì‘ ì‹œê°„
    â”œâ”€â”€ current_speaker: "user_id" | null     // í˜„ì¬ ë°œì–¸ì (ë™ì‹œì„± ì œì–´)
    â”œâ”€â”€ event_id: "uuid"                      // Firestore ì´ë²¤íŠ¸ ì—°ê²°ìš©
    â””â”€â”€ participants: {                       // ì±„ë„ ì°¸ì—¬ì ëª©ë¡
         â”œâ”€â”€ user1_id: {
         â”‚    app_type: "call_manager",
         â”‚    joined_at: timestamp,
         â”‚    last_seen: timestamp,            // Heartbeatìš©
         â”‚    device_info: "Samsung Galaxy S21"
         â”‚ }
         â””â”€â”€ user2_id: {
              app_type: "pickup_driver",
              joined_at: timestamp,
              last_seen: timestamp
         }
       }

  // ëŒ€ê·œëª¨ í™•ì¥ì„ ìœ„í•œ ë³„ë„ ê²½ë¡œ (100ëª… ì´ìƒ ì‚¬ë¬´ì‹¤)
  /ptt_participants/{regionId}_{officeId}/
    â”œâ”€â”€ user1_id: { ... }
    â””â”€â”€ user2_id: { ... }

  // Firestore ì´ë²¤íŠ¸ ë¡œê·¸ (ë¶„ì„ ë° ì˜êµ¬ ì €ì¥ìš©)
  /ptt_events/{eventId}
    â”œâ”€â”€ type: "SESSION_STARTED" | "SESSION_ENDED" | "USER_JOINED" | "USER_LEFT"
    â”œâ”€â”€ sessionId: "regionId_officeId_timestamp"
    â”œâ”€â”€ userId: "user_id"
    â”œâ”€â”€ timestamp: serverTimestamp
    â””â”€â”€ metadata: { ... }

  2.2 í•µì‹¬ í”Œë¡œìš°

  sequenceDiagram
      participant CM as ì½œë§¤ë‹ˆì €
      participant RTDB as Firebase RTDB
      participant PA as í”½ì—…ì•±
      participant AGORA as Agora SDK

      CM->>RTDB: Transactionìœ¼ë¡œ current_speaker ì„ ì 
      RTDB-->>CM: ì„±ê³µ (ë˜ëŠ” ì‹¤íŒ¨)
      CM->>CM: ìì‹ ì˜ í† í° ìƒì„±
      CM->>AGORA: ì±„ë„ ì°¸ì—¬ & ì†¡ì‹  ì‹œì‘
      CM->>RTDB: onDisconnect í•¸ë“¤ëŸ¬ ì„¤ì •

      RTDB->>PA: ì„¸ì…˜ í™œì„±í™” ì´ë²¤íŠ¸ ì „íŒŒ
      PA->>PA: ëœë¤ ë”œë ˆì´ (100-500ms)
      PA->>PA: ìì‹ ì˜ í† í° ìƒì„±
      PA->>AGORA: ìˆ˜ì‹  ì „ìš©ìœ¼ë¡œ ì±„ë„ ì°¸ì—¬
      PA->>RTDB: participantsì— ìì‹  ì¶”ê°€ + onDisconnect ì„¤ì •
      PA->>PA: Heartbeat ì‹œì‘ (1ë¶„ ì£¼ê¸°)

      CM->>RTDB: PTT ë²„íŠ¼ í•´ì œ â†’ ì„¸ì…˜ ë¹„í™œì„±í™”
      RTDB->>PA: ì„¸ì…˜ ì¢…ë£Œ ì´ë²¤íŠ¸ ì „íŒŒ
      PA->>AGORA: ì±„ë„ ì´íƒˆ
      PA->>PA: Heartbeat ì¤‘ì§€

  ---
  ğŸ”’ 3. ë³´ì•ˆ ë° ì•ˆì •ì„± ê°•í™”

  3.1 í† í° ë³´ì•ˆ ê°•í™”

  // âŒ ê¸°ì¡´ ë°©ì‹: í† í° ê³µìœ  (ë³´ì•ˆ ì·¨ì•½)
  // PTT ì„¸ì…˜ì— tokenì„ ì €ì¥í•˜ê³  ëª¨ë“  ì•±ì´ ë™ì¼ í† í° ì‚¬ìš©

  // âœ… ê°œì„ ëœ ë°©ì‹: ê°œë³„ í† í° ìƒì„±
  class SecurePTTTokenManager {
      suspend fun generateMyToken(channelName: String): String? {
          return try {
              val data = hashMapOf(
                  "regionId" to regionId,
                  "officeId" to officeId,
                  "userType" to userType,
                  "userId" to myUserId,  // ğŸ”‘ ê°ì ê³ ìœ  uid ì‚¬ìš©
                  "channelName" to channelName
              )

              val result = functions
                  .getHttpsCallable("generateAgoraToken")
                  .call(data)
                  .await()

              result.data.toString()
          } catch (e: Exception) {
              Log.e(TAG, "Token generation failed", e)
              null
          }
      }
  }

  3.2 ë™ì‹œì„± ì œì–´ - Race Condition ë°©ì§€

  class PTTConcurrencyManager {

      fun attemptToStartPTT(): Boolean {
          val sessionRef = database.child("ptt_sessions/${regionId}_${officeId}")

          return sessionRef.runTransaction(object : Transaction.Handler {
              override fun doTransaction(currentData: MutableData): Transaction.Result {
                  val session = currentData.getValue(PTTSession::class.java)

                  // ğŸ”‘ í•µì‹¬: ì´ë¯¸ ë‹¤ë¥¸ ì‚¬ëŒì´ ë§í•˜ê³  ìˆìœ¼ë©´ ì‹¤íŒ¨
                  if (session != null && session.current_speaker != null) {
                      return Transaction.abort()
                  }

                  // ë‚´ê°€ ë°œì–¸ìë¡œ ì„¸ì…˜ ì‹œì‘
                  val newSession = PTTSession(
                      active = true,
                      current_speaker = myUserId,
                      channel_name = generateChannelName(),
                      started_at = ServerValue.TIMESTAMP,
                      event_id = UUID.randomUUID().toString()
                  )

                  currentData.value = newSession
                  return Transaction.success(currentData)
              }

              override fun onComplete(error: DatabaseError?, committed: Boolean, currentData:
  DataSnapshot?) {
                  if (committed) {
                      // ğŸ‰ ì„±ê³µ! ì‹¤ì œ Agora ì†¡ì‹  ì‹œì‘
                      startSpeakingWithFeedback()
                      setupAutoCleanup()
                  } else {
                      // âš ï¸ ì‹¤íŒ¨: ë‹¤ë¥¸ ì‚¬ëŒì´ ì´ë¯¸ ë§í•˜ëŠ” ì¤‘
                      feedbackManager.onPTTStartFail("ë‹¤ë¥¸ ì‚¬ìš©ìê°€ í†µí™” ì¤‘ì…ë‹ˆë‹¤")
                  }
              }
          })
      }
  }

  ---
  ğŸ“Š 4. ë°ì´í„° ì •í•©ì„± 99.99% ë‹¬ì„±

  4.1 3ì¤‘ ì•ˆì „ì¥ì¹˜ ì‹œìŠ¤í…œ

  /**
   * 1ì°¨ ë°©ì–´: onDisconnect (99% ì»¤ë²„)
   * 2ì°¨ ë°©ì–´: Heartbeat (99.99% ì»¤ë²„)
   * 3ì°¨ ë°©ì–´: Stale Session Cleaner (100% ë³´ì¥)
   */

  class PTTDataIntegrityManager {

      // 1ì°¨: onDisconnect ì„¤ì •
      private fun setupDisconnectHandlers() {
          // ë°œì–¸ììš© onDisconnect
          val sessionRef = database.child("ptt_sessions/${regionId}_${officeId}")
          sessionRef.onDisconnect().updateChildren(mapOf(
              "active" to false,
              "current_speaker" to null,
              "disconnected_at" to ServerValue.TIMESTAMP
          ))

          // ì°¸ì—¬ììš© onDisconnect
          val participantRef = sessionRef.child("participants/${myUserId}")
          participantRef.onDisconnect().removeValue()
      }

      // 2ì°¨: Heartbeat ë©”ì»¤ë‹ˆì¦˜
      class PTTHeartbeatManager {
          private var heartbeatJob: Job? = null
          private val heartbeatInterval = 60_000L // 1ë¶„

          fun startHeartbeat() {
              heartbeatJob = viewModelScope.launch {
                  while (isActive && isCurrentlyInChannel) {
                      try {
                          // ì„¸ì…˜ ìœ íš¨ì„± ì¬í™•ì¸
                          val sessionSnapshot = database
                              .child("ptt_sessions/${regionId}_${officeId}")
                              .get()
                              .await()

                          if (sessionSnapshot.exists()) {
                              // ğŸ”‘ í•µì‹¬: Heartbeat ì „ì†¡
                              database

  .child("ptt_sessions/${regionId}_${officeId}/participants/${myUserId}/last_seen")
                                  .setValue(ServerValue.TIMESTAMP)

                              Log.d(TAG, "Heartbeat sent successfully")
                          } else {
                              Log.i(TAG, "Session ended, stopping heartbeat")
                              break
                          }

                          delay(heartbeatInterval)

                      } catch (e: Exception) {
                          Log.w(TAG, "Heartbeat failed: ${e.message}")
                          delay(heartbeatInterval / 2) // ì‹¤íŒ¨ ì‹œ ë” ë¹ ë¥¸ ì¬ì‹œë„
                      }
                  }
              }
          }

          fun stopHeartbeat() {
              heartbeatJob?.cancel()
              heartbeatJob = null
          }
      }
  }

  4.2 3ì°¨: ê°•í™”ëœ Stale Session Cleaner

  // functions/src/advancedStaleSessionCleaner.ts
  import * as functions from 'firebase-functions';
  import * as admin from 'firebase-admin';

  export const advancedStaleSessionCleaner = functions
      .region('asia-northeast3')
      .pubsub.schedule('every 2 minutes')
      .onRun(async (context) => {
          const database = admin.database();
          const now = Date.now();
          const heartbeatTimeout = 3 * 60 * 1000; // 3ë¶„ (Heartbeat 3íšŒ ëˆ„ë½)

          const sessionsRef = database.ref('ptt_sessions');
          const snapshot = await sessionsRef.once('value');

          const cleanupTasks: Promise<any>[] = [];

          snapshot.forEach((sessionSnapshot) => {
              const session = sessionSnapshot.val();
              const sessionKey = sessionSnapshot.key;

              if (session.participants) {
                  // ğŸ” ê° ì°¸ì—¬ìì˜ last_seen ì²´í¬
                  Object.keys(session.participants).forEach(userId => {
                      const participant = session.participants[userId];
                      const lastSeen = participant.last_seen || participant.joined_at;

                      if (lastSeen && (now - lastSeen) > heartbeatTimeout) {
                          // ğŸ§¹ Heartbeat ëˆ„ë½ ì°¸ì—¬ì ì œê±°
                          cleanupTasks.push(

  sessionsRef.child(sessionKey).child('participants').child(userId).remove()
                          );

                          console.log(`Removed stale participant ${userId} from session
  ${sessionKey}`);
                      }
                  });
              }

              // ğŸ¤ current_speakerë„ Heartbeat ì²´í¬
              if (session.current_speaker && session.started_at) {
                  const speakerLastSeen =
  session.participants?.[session.current_speaker]?.last_seen || session.started_at;

                  if ((now - speakerLastSeen) > heartbeatTimeout) {
                      cleanupTasks.push(
                          sessionsRef.child(sessionKey).update({
                              active: false,
                              current_speaker: null,
                              cleaned_reason: 'speaker_heartbeat_timeout',
                              cleaned_at: admin.database.ServerValue.TIMESTAMP
                          })
                      );

                      console.log(`Cleaned stale session ${sessionKey} - speaker heartbeat
  timeout`);
                  }
              }
          });

          await Promise.all(cleanupTasks);

          if (cleanupTasks.length > 0) {
              console.log(`Stale session cleaner: processed ${cleanupTasks.length} cleanup
  tasks`);
          }
      });

  ---
  ğŸ¨ 5. ìš´ì „ì ì¤‘ì‹¬ UX ì„¤ê³„

  5.1 ì°¨ë³„í™”ëœ ì˜¤ë””ì˜¤ í”¼ë“œë°±

  class PTTAudioFeedbackManager(private val context: Context) {

      enum class PTTSoundType(val resourceName: String, val description: String) {
          PTT_START_SUCCESS("ptt_start_success", "ì‚‘! (ì§§ê³  ëª…í™•í•œ ë¬´ì „ê¸° ì†Œë¦¬)"),
          PTT_START_FAIL("ptt_start_fail", "ì‚ë¹…! (ë‚®ì€ í†¤ì˜ ì—ëŸ¬ìŒ)"),
          PTT_END("ptt_end", "ì‚‘-- (ê¸¸ê³  ë‚®ì•„ì§€ëŠ” ì¢…ë£ŒìŒ)"),
          SESSION_JOIN("session_join", "ëµ! (ë¶€ë“œëŸ¬ìš´ ì°¸ì—¬ ì•Œë¦¼)"),
          SESSION_LEAVE("session_leave", "ë˜‘! (ì§§ì€ ì´íƒˆ ì•Œë¦¼)"),
          SOMEONE_SPEAKING("someone_speaking", "ëµë ë§~ (ë‹¤ë¥¸ ì‚¬ëŒ ë§í•˜ê¸° ì‹œì‘)")
      }

      private val soundPool = SoundPool.Builder()
          .setMaxStreams(5)
          .setAudioAttributes(
              AudioAttributes.Builder()
                  .setUsage(AudioAttributes.USAGE_ASSISTANCE_SONIFICATION)
                  .setContentType(AudioAttributes.CONTENT_TYPE_SONIFICATION)
                  .build()
          )
          .build()

      fun playPTTSound(soundType: PTTSoundType, volume: Float = 0.8f) {
          soundMap[soundType]?.let { soundId ->
              soundPool.play(soundId, volume, volume, 1, 0, 1.0f)
          }

          Log.d(TAG, "Playing sound: ${soundType.description}")
      }
  }

  5.2 ì •êµí•œ í–…í‹± í”¼ë“œë°±

  class PTTHapticFeedbackManager(private val context: Context) {

      enum class PTTHapticType {
          PTT_START_SUCCESS,     // ì§§ê³  ê°•í•œ ì§„ë™ (í´ë¦­ê°)
          PTT_START_FAIL,        // ì§§ê²Œ ë‘ ë²ˆ ìš¸ë¦¬ëŠ” ì§„ë™ (ì‹¤íŒ¨)
          SESSION_NOTIFICATION,  // ë¶€ë“œëŸ½ê³  ê¸´ ì§„ë™ (ì•Œë¦¼)
          PTT_HOLD_FEEDBACK     // ì§€ì†ì ì¸ ë¯¸ì„¸ ì§„ë™ (ì†¡ì‹  ì¤‘)
      }

      fun triggerHaptic(type: PTTHapticType) {
          if (!vibrator.hasVibrator()) return

          val pattern = when (type) {
              PTTHapticType.PTT_START_SUCCESS -> longArrayOf(0, 100)           // ì§§ê³  ê°•í•œ í•œ ë²ˆ
              PTTHapticType.PTT_START_FAIL -> longArrayOf(0, 80, 80, 80)      // ì§§ê²Œ ë‘ ë²ˆ
  (ì‚ë¹…!)
              PTTHapticType.SESSION_NOTIFICATION -> longArrayOf(0, 300)        // ë¶€ë“œëŸ½ê³  ê¸´
  ì§„ë™
              PTTHapticType.PTT_HOLD_FEEDBACK -> longArrayOf(0, 50, 200, 50, 200, 50) // ì§€ì†ì 
  ë¯¸ì„¸ ì§„ë™
          }

          val amplitudes = when (type) {
              PTTHapticType.PTT_START_SUCCESS -> intArrayOf(255)     // ìµœëŒ€ ê°•ë„
              PTTHapticType.PTT_START_FAIL -> intArrayOf(200, 200)   // ì¤‘ê°„ ê°•ë„
              PTTHapticType.SESSION_NOTIFICATION -> intArrayOf(150)  // ë¶€ë“œëŸ¬ìš´ ê°•ë„
              PTTHapticType.PTT_HOLD_FEEDBACK -> intArrayOf(100, 100, 100) // ë¯¸ì„¸ ì§„ë™
          }

          if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
              vibrator.vibrate(VibrationEffect.createWaveform(pattern, amplitudes, -1))
          }
      }
  }

  5.3 TTS ê¸°ë°˜ ìŒì„± ì•ˆë‚´

  class PTTVoiceAssistant(private val context: Context) {

      private var tts: TextToSpeech? = null

      init {
          tts = TextToSpeech(context) { status ->
              if (status == TextToSpeech.SUCCESS) {
                  tts?.language = Locale.KOREAN
              }
          }
      }

      fun announceEvent(event: PTTEvent) {
          val announcement = when (event.type) {
              PTTEventType.SESSION_STARTED -> "${event.speakerName}ë‹˜ì´ PTTë¥¼ ì‹œì‘í–ˆìŠµë‹ˆë‹¤"
              PTTEventType.SESSION_ENDED -> "PTTê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤"
              PTTEventType.USER_JOINED -> "${event.userName}ë‹˜ì´ ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤"
              PTTEventType.PTT_BUSY -> "ë‹¤ë¥¸ ì‚¬ìš©ìê°€ í†µí™” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”"
          }

          tts?.speak(announcement, TextToSpeech.QUEUE_FLUSH, null, null)
      }
  }

  5.4 ì˜¤ë””ì˜¤ í¬ì»¤ìŠ¤ ê´€ë¦¬

  class PTTAudioFocusManager(private val context: Context) {

      private val audioManager = context.getSystemService(Context.AUDIO_SERVICE) as AudioManager

      @TargetApi(Build.VERSION_CODES.O)
      private val focusRequest =
  AudioFocusRequest.Builder(AudioManager.AUDIOFOCUS_GAIN_TRANSIENT)
          .setAudioAttributes(
              AudioAttributes.Builder()
                  .setUsage(AudioAttributes.USAGE_VOICE_COMMUNICATION)
                  .setContentType(AudioAttributes.CONTENT_TYPE_SPEECH)
                  .build()
          )
          .setOnAudioFocusChangeListener { focusChange ->
              when (focusChange) {
                  AudioManager.AUDIOFOCUS_LOSS -> {
                      // ğŸ›‘ í¬ì»¤ìŠ¤ ì™„ì „ ìƒì‹¤ - PTT ê°•ì œ ì¤‘ë‹¨
                      forceStopPTT()
                  }
                  AudioManager.AUDIOFOCUS_LOSS_TRANSIENT -> {
                      // â¸ï¸ ì¼ì‹œì  ìƒì‹¤ - PTT ì¼ì‹œ ì •ì§€
                      pausePTT()
                  }
                  AudioManager.AUDIOFOCUS_GAIN -> {
                      // â–¶ï¸ í¬ì»¤ìŠ¤ íšŒë³µ - PTT ì¬ê°œ
                      resumePTT()
                  }
              }
          }
          .build()

      fun requestAudioFocus(): Boolean {
          return if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
              audioManager.requestAudioFocus(focusRequest) ==
  AudioManager.AUDIOFOCUS_REQUEST_GRANTED
          } else {
              @Suppress("DEPRECATION")
              audioManager.requestAudioFocus(
                  null,
                  AudioManager.STREAM_VOICE_CALL,
                  AudioManager.AUDIOFOCUS_GAIN_TRANSIENT
              ) == AudioManager.AUDIOFOCUS_REQUEST_GRANTED
          }
      }
  }

  ---
  ğŸ“ˆ 6. ëŒ€ê·œëª¨ í™•ì¥ì„± ì„¤ê³„

  6.1 ì„œë²„ ë¶€í•˜ ë¶„ì‚° - Thundering Herd ë°©ì§€

  class PTTLoadBalancer {

      // ğŸ”‘ í•µì‹¬: ëœë¤ ë”œë ˆì´ë¡œ ë™ì‹œ ìš”ì²­ ë¶„ì‚°
      private suspend fun handleSessionStartEvent(session: PTTSession) {
          if (session.active && session.current_speaker != myUserId) {
              if (!isCurrentlyInChannel) {
                  // 100~500ms ëœë¤ ë”œë ˆì´ë¡œ Firebase Functions í˜¸ì¶œ ë¶„ì‚°
                  val randomDelay = Random.nextLong(100, 500)

                  viewModelScope.launch {
                      delay(randomDelay)

                      // ë”œë ˆì´ í›„ ì„¸ì…˜ì´ ì—¬ì „íˆ í™œì„±ì¸ì§€ ì¬í™•ì¸
                      val currentSession = database.child("ptt_sessions/${regionId}_${officeId}")
                          .get().await().getValue<PTTSession>()

                      if (currentSession?.active == true) {
                          autoJoinAsListener(currentSession.channel_name)

  feedbackManager.onSomeoneStartedSpeaking(currentSession.current_speaker)
                      }
                  }
              }
          }
      }
  }

  6.2 ì´ë²¤íŠ¸ ê¸°ë°˜ í™•ì¥ ëª¨ë¸

  // ëŒ€ê·œëª¨ ì‚¬ë¬´ì‹¤ (100ëª… ì´ìƒ)ì„ ìœ„í•œ ì´ë²¤íŠ¸ ê¸°ë°˜ ì•„í‚¤í…ì²˜
  data class PTTEvent(
      val eventId: String = UUID.randomUUID().toString(),
      val type: PTTEventType,
      val sessionId: String,
      val userId: String,
      val userName: String,
      val timestamp: Long = System.currentTimeMillis(),
      val metadata: Map<String, Any> = emptyMap()
  )

  enum class PTTEventType {
      SESSION_STARTED,
      SESSION_ENDED,
      USER_JOINED,
      USER_LEFT,
      SPEAKER_CHANGED,
      HEARTBEAT_LOST
  }

  class ScalablePTTManager {

      // ğŸ”‘ í•µì‹¬: Firestore + RTDB í•˜ì´ë¸Œë¦¬ë“œ ë°©ì‹
      suspend fun startScalablePTTSession(): Boolean {
          return try {
              // 1. Firestoreì— ì´ë²¤íŠ¸ ë¡œê·¸ (ì˜êµ¬ ì €ì¥, ë¶„ì„ìš©)
              val event = PTTEvent(
                  type = PTTEventType.SESSION_STARTED,
                  sessionId = "${regionId}_${officeId}_${System.currentTimeMillis()}",
                  userId = myUserId,
                  userName = getUserName()
              )

              firestore.collection("ptt_events")
                  .document(event.eventId)
                  .set(event)

              // 2. RTDBì— ì‹¤ì‹œê°„ ì„¸ì…˜ ìƒíƒœ (ë¹ ë¥¸ ë™ê¸°í™”ìš©)
              val sessionData = mapOf(
                  "active" to true,
                  "current_speaker" to myUserId,
                  "event_id" to event.eventId,
                  "started_at" to ServerValue.TIMESTAMP
              )

              realtimeDb.reference
                  .child("ptt_sessions/${regionId}_${officeId}")
                  .setValue(sessionData)
                  .await()

              true
          } catch (e: Exception) {
              Log.e(TAG, "Failed to start scalable PTT session", e)
              false
          }
      }
  }

  ---
  ğŸ›ï¸ 7. ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ë° ê´€ë¦¬

  7.1 ì‹¤ì‹œê°„ PTT ëŒ€ì‹œë³´ë“œ

  @Composable
  fun PTTManagementDashboard(
      regionId: String,
      officeId: String
  ) {
      val activeSessions by remember { mutableStateOf(emptyList<PTTSession>()) }
      val totalParticipants by remember { mutableStateOf(0) }
      val dailyUsageStats by remember { mutableStateOf(PTTUsageStats()) }

      LaunchedEffect(regionId, officeId) {
          // Firestoreì—ì„œ ì‚¬ìš©ëŸ‰ í†µê³„ ì‹¤ì‹œê°„ ìˆ˜ì§‘
          FirebaseFirestore.getInstance()
              .collection("ptt_events")
              .whereEqualTo("sessionId", "${regionId}_${officeId}")
              .whereGreaterThan("timestamp", getTodayStartTimestamp())
              .addSnapshotListener { snapshot, error ->
                  if (snapshot != null) {
                      dailyUsageStats = calculateUsageStats(snapshot.documents)
                  }
              }
      }

      Card(
          modifier = Modifier.fillMaxWidth(),
          colors = CardDefaults.cardColors(containerColor = Color(0xFF1A1A1A))
      ) {
          Column(
              modifier = Modifier.padding(16.dp),
              verticalArrangement = Arrangement.spacedBy(16.dp)
          ) {
              Text(
                  "PTT ì‹œìŠ¤í…œ í˜„í™©",
                  style = MaterialTheme.typography.headlineMedium,
                  color = Color.White
              )

              Row(
                  modifier = Modifier.fillMaxWidth(),
                  horizontalArrangement = Arrangement.SpaceEvenly
              ) {
                  InfoCard("í™œì„± ì„¸ì…˜", activeSessions.size.toString())
                  InfoCard("ì°¸ì—¬ì ìˆ˜", totalParticipants.toString())
                  InfoCard("ì˜¤ëŠ˜ ì‚¬ìš©ëŸ‰", "${dailyUsageStats.totalMinutes}ë¶„")
                  InfoCard("í‰ê·  ì„¸ì…˜", "${dailyUsageStats.averageSessionMinutes}ë¶„")
              }

              // ğŸ“Š ì‹¤ì‹œê°„ ì„¸ì…˜ ëª©ë¡
              LazyColumn {
                  items(activeSessions) { session ->
                      PTTSessionCard(session = session)
                  }
              }
          }
      }
  }

  @Composable
  fun InfoCard(title: String, value: String) {
      Card(
          colors = CardDefaults.cardColors(containerColor = Color(0xFF2A2A2A))
      ) {
          Column(
              modifier = Modifier.padding(12.dp),
              horizontalAlignment = Alignment.CenterHorizontally
          ) {
              Text(
                  text = value,
                  style = MaterialTheme.typography.headlineSmall,
                  color = Color.White,
                  fontWeight = FontWeight.Bold
              )
              Text(
                  text = title,
                  style = MaterialTheme.typography.bodySmall,
                  color = Color.LightGray
              )
          }
      }
  }

  7.2 ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§

  class PTTPerformanceMonitor {

      data class PTTMetrics(
          val sessionStartLatency: Long,
          val tokenGenerationTime: Long,
          val channelJoinTime: Long,
          val participantCount: Int,
          val heartbeatSuccessRate: Float
      )

      fun recordSessionMetrics(sessionId: String, metrics: PTTMetrics) {
          FirebaseFirestore.getInstance()
              .collection("ptt_metrics")
              .document(sessionId)
              .set(mapOf(
                  "session_start_latency_ms" to metrics.sessionStartLatency,
                  "token_generation_time_ms" to metrics.tokenGenerationTime,
                  "channel_join_time_ms" to metrics.channelJoinTime,
                  "participant_count" to metrics.participantCount,
                  "heartbeat_success_rate" to metrics.heartbeatSuccessRate,
                  "timestamp" to FieldValue.serverTimestamp(),
                  "region_id" to regionId,
                  "office_id" to officeId
              ))
      }

      fun generateDailyReport(): PTTDailyReport {
          // Firestore ì¿¼ë¦¬ë¡œ ì¼ì¼ ì‚¬ìš©ëŸ‰ í†µê³„ ìƒì„±
          // - ì´ ì„¸ì…˜ ìˆ˜
          // - í‰ê·  ì„¸ì…˜ ê¸¸ì´
          // - ìµœëŒ€ ë™ì‹œ ì°¸ì—¬ì ìˆ˜
          // - ì—ëŸ¬ìœ¨
          // - í‰ê·  ì‘ë‹µ ì‹œê°„
      }
  }

  ---
  ğŸš€ 8. êµ¬í˜„ ë¡œë“œë§µ

  ğŸ“… Phase 1: í•µì‹¬ ì•ˆì •ì„± (1-2ì£¼)

  ëª©í‘œ: 99.99% ë°ì´í„° ì •í•©ì„± ë‹¬ì„±

  | ì‘ì—…                        | ì„¤ëª…                   | ìš°ì„ ìˆœìœ„  |
  |---------------------------|----------------------|-------|
  | Heartbeat ë©”ì»¤ë‹ˆì¦˜            | 1ë¶„ ì£¼ê¸° ìƒì¡´ ì‹ í˜¸ ì „ì†¡       | ğŸ”´ í•„ìˆ˜ |
  | ê°•í™”ëœ Stale Session Cleaner | 3ì¤‘ ì•ˆì „ì¥ì¹˜ ì™„ì„±           | ğŸ”´ í•„ìˆ˜ |
  | Transaction ê¸°ë°˜ ë™ì‹œì„± ì œì–´     | Race Condition ì™„ì „ ë°©ì§€ | ğŸ”´ í•„ìˆ˜ |
  | onDisconnect í•¸ë“¤ëŸ¬          | ìë™ ì„¸ì…˜ ì •ë¦¬             | ğŸ”´ í•„ìˆ˜ |

  ê²€ì¦ ê¸°ì¤€:
  - ë¹„ì •ìƒ ì¢…ë£Œ ì‹œ 5ì´ˆ ì´ë‚´ ì„¸ì…˜ ì •ë¦¬
  - ë™ì‹œ PTT ì‹œë„ ì‹œ 100% ì¶©ëŒ ë°©ì§€
  - Heartbeat ëˆ„ë½ ì‹œ 3ë¶„ ì´ë‚´ ìë™ ì œê±°

  ğŸ“… Phase 2: ìš´ì „ì ì¤‘ì‹¬ UX (1ì£¼)

  ëª©í‘œ: í™”ë©´ì„ ë³´ì§€ ì•Šê³ ë„ PTT ìƒíƒœ ì¸ì§€ ê°€ëŠ¥

  | ì‘ì—…           | ì„¤ëª…           | ìš°ì„ ìˆœìœ„  |
  |--------------|--------------|-------|
  | ì°¨ë³„í™”ëœ ì˜¤ë””ì˜¤ í”¼ë“œë°± | 6ê°€ì§€ ìƒí™©ë³„ íš¨ê³¼ìŒ  | ğŸŸ¡ ì¤‘ìš” |
  | ì •êµí•œ í–…í‹± í”¼ë“œë°±   | 4ê°€ì§€ íŒ¨í„´ ì§„ë™    | ğŸŸ¡ ì¤‘ìš” |
  | TTS ìŒì„± ì•ˆë‚´    | ë°œì–¸ì ì´ë¦„ ìŒì„± ì•Œë¦¼ | ğŸŸ¡ ì¤‘ìš” |
  | ì˜¤ë””ì˜¤ í¬ì»¤ìŠ¤ ê´€ë¦¬   | ë‚´ë¹„/ìŒì•…ê³¼ ì¶©ëŒ ë°©ì§€ | ğŸŸ¡ ì¤‘ìš” |

  ê²€ì¦ ê¸°ì¤€:
  - ëª¨ë“  PTT ìƒíƒœ ë³€í™”ì— ì¦‰ê°ì ì¸ í”¼ë“œë°± ì œê³µ
  - ë‹¤ë¥¸ ì•± ì˜¤ë””ì˜¤ì™€ ìì—°ìŠ¤ëŸ¬ìš´ ì „í™˜
  - ìš´ì „ ì¤‘ ì•ˆì „í•œ ì‚¬ìš© ê°€ëŠ¥

  ğŸ“… Phase 3: í™•ì¥ì„± ë° ìµœì í™” (1-2ì£¼)

  ëª©í‘œ: ì‚¬ë¬´ì‹¤ë‹¹ 500ëª… ë™ì‹œ ì§€ì›

  | ì‘ì—…                 | ì„¤ëª…                 | ìš°ì„ ìˆœìœ„  |
  |--------------------|--------------------|-------|
  | Thundering Herd ë°©ì§€ | ëœë¤ ë”œë ˆì´ ë¶€í•˜ ë¶„ì‚°       | ğŸŸ¢ ì„ íƒ |
  | ì´ë²¤íŠ¸ ê¸°ë°˜ ì•„í‚¤í…ì²˜        | Firestore í•˜ì´ë¸Œë¦¬ë“œ ëª¨ë¸ | ğŸŸ¢ ì„ íƒ |
  | ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ      | ê´€ë¦¬ììš© ëª¨ë‹ˆí„°ë§ íˆ´        | ğŸŸ¢ ì„ íƒ |
  | ì„±ëŠ¥ ìµœì í™”             | ì‘ë‹µì†ë„ < 100ms ë‹¬ì„±    | ğŸŸ¢ ì„ íƒ |

  ê²€ì¦ ê¸°ì¤€:
  - 100ëª… ë™ì‹œ ì ‘ì† í…ŒìŠ¤íŠ¸ í†µê³¼
  - í‰ê·  ì‘ë‹µ ì‹œê°„ 100ms ì´í•˜
  - ì¼ì¼ ëª¨ë‹ˆí„°ë§ ë¦¬í¬íŠ¸ ìë™ ìƒì„±

  ğŸ“… Phase 4: í…ŒìŠ¤íŠ¸ & ë°°í¬ (1ì£¼)

  ëª©í‘œ: í”„ë¡œë•ì…˜ ë°°í¬ ì¤€ë¹„ ì™„ë£Œ

  | ì‘ì—…      | ì„¤ëª…             | ìš°ì„ ìˆœìœ„  |
  |---------|----------------|-------|
  | í†µí•© í…ŒìŠ¤íŠ¸  | í¬ë¡œìŠ¤ ì•± ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸ | ğŸ”´ í•„ìˆ˜ |
  | ë¶€í•˜ í…ŒìŠ¤íŠ¸  | ëŒ€ê·œëª¨ ë™ì‹œ ì ‘ì† í…ŒìŠ¤íŠ¸  | ğŸ”´ í•„ìˆ˜ |
  | ë³´ì•ˆ ê°ì‚¬   | í† í° ë³´ì•ˆ ë° ê¶Œí•œ ê²€ì¦  | ğŸ”´ í•„ìˆ˜ |
  | ì‚¬ìš©ì í…ŒìŠ¤íŠ¸ | ì‹¤ì œ ê¸°ì‚¬ë“¤ íŒŒì¼ëŸ¿ í…ŒìŠ¤íŠ¸ | ğŸ”´ í•„ìˆ˜ |

  ---
  ğŸ“Š 9. ì„±ëŠ¥ ëª©í‘œ ë° KPI

  9.1 í•µì‹¬ ì„±ëŠ¥ ì§€í‘œ

  | ì§€í‘œ       | ëª©í‘œê°’      | ì¸¡ì • ë°©ë²•                                  |
  |----------|----------|----------------------------------------|
  | ë°ì´í„° ì •í•©ì„±  | 99.99%   | onDisconnect + Heartbeat + Cleaner ì„±ê³µë¥  |
  | ì‘ë‹µ ì§€ì—°    | < 100ms  | PTT ë²„íŠ¼ í´ë¦­ â†’ ë‹¤ë¥¸ ì•± ì•Œë¦¼ ìˆ˜ì‹  ì‹œê°„              |
  | í† í° ìƒì„± ì‹œê°„ | < 500ms  | Firebase Functions í˜¸ì¶œ â†’ ì‘ë‹µ ì‹œê°„          |
  | ì±„ë„ ì°¸ì—¬ ì‹œê°„ | < 1ì´ˆ     | Agora ì±„ë„ ì°¸ì—¬ ì™„ë£Œ ì‹œê°„                      |
  | ë™ì‹œ ì ‘ì†    | 500ëª…/ì‚¬ë¬´ì‹¤ | ë¶€í•˜ í…ŒìŠ¤íŠ¸ë¡œ ê²€ì¦                             |
  | ì—ëŸ¬ìœ¨      | < 0.1%   | ì „ì²´ PTT ì‹œë„ ëŒ€ë¹„ ì‹¤íŒ¨ìœ¨                       |
  | ì‹œìŠ¤í…œ ê°€ìš©ì„±  | 99.9%    | ì›”ê°„ ë‹¤ìš´íƒ€ì„ < 43ë¶„                          |

  9.2 ì‚¬ìš©ì ê²½í—˜ KPI

  | ì§€í‘œ        | ëª©í‘œê°’    | ì¸¡ì • ë°©ë²•               |
  |-----------|--------|---------------------|
  | ì‚¬ìš©ì ë§Œì¡±ë„   | 95%+   | íŒŒì¼ëŸ¿ í…ŒìŠ¤íŠ¸ ì„¤ë¬¸ì¡°ì‚¬        |
  | PTT ì„±ê³µë¥    | 99%+   | ì‹¤ì œ í†µí™” ì—°ê²° ì„±ê³µë¥         |
  | í‰ê·  ì„¸ì…˜ ê¸¸ì´  | 30ì´ˆ ì´í•˜ | Firestore ì´ë²¤íŠ¸ ë¡œê·¸ ë¶„ì„ |
  | ì¼ì¼ í™œì„± ì‚¬ìš©ì | 80%+   | ë“±ë¡ ê¸°ì‚¬ ëŒ€ë¹„ ì‚¬ìš©ë¥         |

  9.3 ë¹„ìš© ìµœì í™” ëª©í‘œ

  | ì§€í‘œ          | ëª©í‘œê°’      | ë°©ë²•                   |
  |-------------|----------|----------------------|
  | Agora ë¹„ìš©    | 50% ì ˆê°   | ì¦‰ì‹œ ì±„ë„ ì´íƒˆ + ìˆ˜ì‹  ì „ìš© ëª¨ë“œ  |
  | Firebase ë¹„ìš© | í˜„ì¬ ìˆ˜ì¤€ ìœ ì§€ | íš¨ìœ¨ì ì¸ ë°ì´í„° êµ¬ì¡° + ì¿¼ë¦¬ ìµœì í™” |
  | ì„œë²„ ë¶€í•˜       | 30% ë¶„ì‚°   | ëœë¤ ë”œë ˆì´ + ì§€ì—­ë³„ ë¶„ì‚°      |

  ---
  ğŸ”§ 10. ê¸°ìˆ  êµ¬í˜„ ì„¸ë¶€ì‚¬í•­

  10.1 ê°œë°œ í™˜ê²½ ì„¤ì •

  // build.gradle.kts (ì•± ë ˆë²¨)
  dependencies {
      // Firebase
      implementation(platform("com.google.firebase:firebase-bom:32.7.0"))
      implementation("com.google.firebase:firebase-auth-ktx")
      implementation("com.google.firebase:firebase-firestore-ktx")
      implementation("com.google.firebase:firebase-database-ktx")
      implementation("com.google.firebase:firebase-functions-ktx")

      // Agora SDK
      implementation("io.agora.rtc:voice-sdk:4.2.6")

      // Coroutines
      implementation("org.jetbrains.kotlinx:kotlinx-coroutines-play-services:1.7.3")

      // Lifecycle
      implementation("androidx.lifecycle:lifecycle-viewmodel-compose:2.7.0")
      implementation("androidx.lifecycle:lifecycle-runtime-compose:2.7.0")
  }

  10.2 Firebase ë³´ì•ˆ ê·œì¹™

  // Realtime Database Rules
  {
    "rules": {
      "ptt_sessions": {
        "$session_id": {
          ".read": "auth != null && $session_id.matches('.*_' +
  root.child('users').child(auth.uid).child('officeId').val() + '.*')",
          ".write": "auth != null && $session_id.matches('.*_' +
  root.child('users').child(auth.uid).child('officeId').val() + '.*')",
          "participants": {
            "$user_id": {
              ".write": "auth.uid == $user_id"
            }
          },
          "current_speaker": {
            ".write": "auth.uid == newData.val() || auth.uid == data.val()"
          }
        }
      }
    }
  }

  // Firestore Rules
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      match /ptt_events/{eventId} {
        allow read, write: if request.auth != null
          && resource.data.sessionId.matches('.*_' +
  get(/databases/$(database)/documents/users/$(request.auth.uid)).data.officeId + '.*');
      }

      match /ptt_metrics/{sessionId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null
          && resource.data.office_id ==
  get(/databases/$(database)/documents/users/$(request.auth.uid)).data.officeId;
      }
    }
  }

  10.3 Cloud Functions êµ¬í˜„

  // functions/src/generateAgoraToken.ts
  import * as functions from 'firebase-functions';
  import { RtcTokenBuilder, RtcRole } from 'agora-token';

  export const generateAgoraToken = functions
      .region('asia-northeast3')
      .https.onCall(async (data, context) => {
          // ì¸ì¦ í™•ì¸
          if (!context.auth) {
              throw new functions.https.HttpsError('unauthenticated', 'User must be
  authenticated');
          }

          const { regionId, officeId, userType, userId, channelName } = data;

          // ê¶Œí•œ í™•ì¸ (ê°™ì€ ì‚¬ë¬´ì‹¤ë§Œ ì ‘ê·¼ ê°€ëŠ¥)
          const userDoc = await admin.firestore()
              .collection('users')
              .doc(context.auth.uid)
              .get();

          if (!userDoc.exists || userDoc.data()?.officeId !== officeId) {
              throw new functions.https.HttpsError('permission-denied', 'Access denied');
          }

          try {
              const appId = "e5aae3aa18484cd2a1fed0018cfb15bd";
              const appCertificate = functions.config().agora.app_certificate;
              const uid = parseInt(context.auth.uid.substring(0, 8), 16); // uid ìƒì„±
              const role = RtcRole.SUBSCRIBER; // ìˆ˜ì‹  ì „ìš©
              const expirationTimeInSeconds = 3600; // 1ì‹œê°„

              const currentTimestamp = Math.floor(Date.now() / 1000);
              const privilegeExpiredTs = currentTimestamp + expirationTimeInSeconds;

              const token = RtcTokenBuilder.buildTokenWithUid(
                  appId,
                  appCertificate,
                  channelName,
                  uid,
                  role,
                  privilegeExpiredTs
              );

              return {
                  token,
                  uid,
                  channelName,
                  expiresAt: privilegeExpiredTs,
                  role: 'subscriber'
              };

          } catch (error) {
              console.error('Token generation error:', error);
              throw new functions.https.HttpsError('internal', 'Token generation failed');
          }
      });

  ---
  ğŸ§ª 11. í…ŒìŠ¤íŠ¸ ê³„íš

  11.1 ë‹¨ìœ„ í…ŒìŠ¤íŠ¸

  class PTTManagerTest {

      @Test
      fun `heartbeat should update last_seen timestamp`() = runTest {
          // Given
          val pttManager = PTTManager.getInstance(context, "pickup_driver", "region1", "office1")
          val mockDatabase = mockk<DatabaseReference>()

          // When
          pttManager.sendHeartbeat()

          // Then
          verify { mockDatabase.child("participants/user123/last_seen").setValue(any()) }
      }

      @Test
      fun `concurrent PTT attempts should fail for second user`() = runTest {
          // Given
          val sessionRef = mockk<DatabaseReference>()
          val transaction = mockk<Transaction.Handler>()

          // When
          val firstAttempt = pttManager.attemptToStartPTT()
          val secondAttempt = pttManager.attemptToStartPTT()

          // Then
          assertTrue(firstAttempt)
          assertFalse(secondAttempt)
      }
  }

  11.2 í†µí•© í…ŒìŠ¤íŠ¸

  @RunWith(AndroidJUnit4::class)
  class PTTIntegrationTest {

      @Test
      fun `cross_app_ptt_communication_should_work`() = runTest {
          // Given: ì½œë§¤ë‹ˆì €ì™€ í”½ì—…ì•± ì¸ìŠ¤í„´ìŠ¤
          val callManagerPTT = PTTManager.getInstance(context, "call_manager", "region1",
  "office1")
          val pickupAppPTT = PTTManager.getInstance(context, "pickup_driver", "region1",
  "office1")

          // When: ì½œë§¤ë‹ˆì €ì—ì„œ PTT ì‹œì‘
          callManagerPTT.startPTT()

          // Then: í”½ì—…ì•±ì´ ìë™ìœ¼ë¡œ ìˆ˜ì‹  ëª¨ë“œ ì§„ì…
          delay(1000) // ë„¤íŠ¸ì›Œí¬ ì§€ì—° ê³ ë ¤
          assertTrue(pickupAppPTT.isListening())
          assertEquals("call_manager_user", pickupAppPTT.getCurrentSpeaker())
      }
  }

  11.3 ë¶€í•˜ í…ŒìŠ¤íŠ¸

  class PTTLoadTest {

      @Test
      fun `should_handle_100_concurrent_users`() = runTest {
          // Given: 100ëª…ì˜ ë™ì‹œ ì‚¬ìš©ì ì‹œë®¬ë ˆì´ì…˜
          val users = (1..100).map { userId ->
              PTTManager.getInstance(context, "pickup_driver", "region1", "office1")
          }

          // When: ë™ì‹œì— PTT ì„¸ì…˜ ì°¸ì—¬ ì‹œë„
          val results = users.map { pttManager ->
              async { pttManager.joinPTTSession() }
          }.awaitAll()

          // Then: ëª¨ë“  ì‚¬ìš©ìê°€ ì„±ê³µì ìœ¼ë¡œ ì°¸ì—¬
          assertTrue(results.all { it })

          // And: ì‹œìŠ¤í…œ ì‘ë‹µ ì‹œê°„ì´ ëª©í‘œì¹˜ ì´ë‚´
          assertTrue(averageResponseTime < 100) // 100ms ì´ë‚´
      }
  }

  ---
  ğŸ“š 12. ë¬¸ì„œí™” ë° ìš´ì˜ ê°€ì´ë“œ

  12.1 API ë¬¸ì„œ

  /**
   * PTT ì‹œìŠ¤í…œ í•µì‹¬ í´ë˜ìŠ¤
   *
   * @param context Android Context
   * @param userType ì‚¬ìš©ì íƒ€ì… ("call_manager", "pickup_driver")
   * @param regionId ì§€ì—­ ID
   * @param officeId ì‚¬ë¬´ì‹¤ ID
   */
  class PTTManager private constructor(
      private val context: Context,
      private val userType: String,
      private val regionId: String,
      private val officeId: String
  ) {

      /**
       * PTT ì„¸ì…˜ ì‹œì‘
       * @return ì„±ê³µ ì—¬ë¶€
       */
      suspend fun startPTTSession(): Boolean

      /**
       * PTT ì„¸ì…˜ ì¢…ë£Œ
       */
      fun stopPTTSession()

      /**
       * ìë™ ì±„ë„ ì°¸ì—¬ (ë‹¤ë¥¸ ì‚¬ìš©ìê°€ PTT ì‹œì‘ ì‹œ)
       * @param channelName ì°¸ì—¬í•  ì±„ë„ëª…
       */
      suspend fun autoJoinAsListener(channelName: String)

      /**
       * Heartbeat ì „ì†¡ (ìƒì¡´ ì‹ í˜¸)
       */
      suspend fun sendHeartbeat()
  }

  12.2 ìš´ì˜ ê°€ì´ë“œ

  ëª¨ë‹ˆí„°ë§ ì²´í¬ë¦¬ìŠ¤íŠ¸

  - ì¼ì¼ ì²´í¬ì‚¬í•­
    - í™œì„± PTT ì„¸ì…˜ ìˆ˜ í™•ì¸
    - ì—ëŸ¬ìœ¨ ì²´í¬ (< 0.1%)
    - í‰ê·  ì‘ë‹µì‹œê°„ í™•ì¸ (< 100ms)
  - ì£¼ê°„ ì²´í¬ì‚¬í•­
    - Stale Session Cleaner ë¡œê·¸ ê²€í† 
    - Heartbeat ì‹¤íŒ¨ìœ¨ ë¶„ì„
    - Agora ì‚¬ìš©ëŸ‰ ë° ë¹„ìš© ë¦¬ë·°
  - ì›”ê°„ ì²´í¬ì‚¬í•­
    - ì „ì²´ ì‹œìŠ¤í…œ ì„±ëŠ¥ ë¦¬í¬íŠ¸
    - ì‚¬ìš©ì í”¼ë“œë°± ìˆ˜ì§‘ ë° ê°œì„ ì  ë„ì¶œ
    - ë³´ì•ˆ ê°ì‚¬ ë° ì—…ë°ì´íŠ¸

  ì¥ì•  ëŒ€ì‘ ì ˆì°¨

  1. PTT ì—°ê²° ì‹¤íŒ¨ ì‹œ
  # Firebase Functions ë¡œê·¸ í™•ì¸
  firebase functions:log --only generateAgoraToken

  # Realtime Database ì„¸ì…˜ ìƒíƒœ í™•ì¸
  firebase database:get /ptt_sessions
  2. ë†’ì€ ì—ëŸ¬ìœ¨ ê°ì§€ ì‹œ
  # Stale Session Cleaner ê°•ì œ ì‹¤í–‰
  firebase functions:shell
  > advancedStaleSessionCleaner()
  3. ì„±ëŠ¥ ì €í•˜ ì‹œ
  # í˜„ì¬ í™œì„± ì„¸ì…˜ ìˆ˜ í™•ì¸
  firebase database:get /ptt_sessions --shallow

  # ë¶€í•˜ ë¶„ì‚° ìƒíƒœ ì ê²€

  ---
  ğŸ‰ 13. ê²°ë¡  ë° ê¸°ëŒ€íš¨ê³¼

  13.1 í•µì‹¬ ë‹¬ì„± ëª©í‘œ

  | ì˜ì—­      | í˜„ì¬    | ëª©í‘œ     | ê°œì„ ìœ¨    |
  |---------|-------|--------|--------|
  | ë°ì´í„° ì •í•©ì„± | 95%   | 99.99% | +5.2%  |
  | ì‚¬ìš©ì ê²½í—˜  | ê¸°ë³¸    | ìš´ì „ì íŠ¹í™” | +300%  |
  | ì‹œìŠ¤í…œ í™•ì¥ì„± | 50ëª…   | 500ëª…   | +1000% |
  | ìš´ì˜ íš¨ìœ¨ì„±  | ìˆ˜ë™ ê´€ë¦¬ | ìë™í™”    | +500%  |

  13.2 ë¹„ì¦ˆë‹ˆìŠ¤ ì„íŒ©íŠ¸

  - ğŸš€ ì‚¬ìš©ì ë§Œì¡±ë„ 95% ì´ìƒ: ìš´ì „ì ì¤‘ì‹¬ UXë¡œ ì•ˆì „í•˜ê³  í¸ë¦¬í•œ PTT ê²½í—˜
  - ğŸ’° ìš´ì˜ ë¹„ìš© 30% ì ˆê°: ìë™í™”ëœ ì„¸ì…˜ ê´€ë¦¬ë¡œ ìˆ˜ë™ ê°œì… ìµœì†Œí™”
  - ğŸ“ˆ ì‹œìŠ¤í…œ í™•ì¥ì„±: í–¥í›„ ì¶”ê°€ ì•± ë° ê¸°ëŠ¥ í™•ì¥ ìš©ì´
  - ğŸ›¡ï¸ ê¸°ì—…ê¸‰ ì•ˆì •ì„±: 99.99% ë°ì´í„° ì •í•©ì„±ìœ¼ë¡œ ë¬´ì¤‘ë‹¨ ì„œë¹„ìŠ¤ ì œê³µ

  13.3 ê¸°ìˆ ì  ì„±ê³¼

  - ì—…ê³„ ìµœê³  ìˆ˜ì¤€ì˜ PTT ì‹œìŠ¤í…œ: 3ì¤‘ ì•ˆì „ì¥ì¹˜ë¡œ ì™„ë²½í•œ ì„¸ì…˜ ê´€ë¦¬
  - í˜ì‹ ì ì¸ UX ì„¤ê³„: ì‹œê°/ì²­ê°/í–…í‹± í†µí•© í”¼ë“œë°±ìœ¼ë¡œ ìš´ì „ì ì•ˆì „ ë³´ì¥
  - í™•ì¥ ê°€ëŠ¥í•œ ì•„í‚¤í…ì²˜: ì´ë²¤íŠ¸ ê¸°ë°˜ ëª¨ë¸ë¡œ ë¬´ì œí•œ í™•ì¥ ì§€ì›
  - ì™„ì „ ìë™í™”ëœ ìš´ì˜: ëª¨ë‹ˆí„°ë§ë¶€í„° ì¥ì•  ë³µêµ¬ê¹Œì§€ ìë™í™”

  ---
  ğŸ“ 14. ì—°ë½ì²˜ ë° ì§€ì›

  14.1 ê°œë°œíŒ€ ì—°ë½ì²˜

  - í”„ë¡œì íŠ¸ ë¦¬ë”: [ì´ë¦„] ([ì´ë©”ì¼])
  - ì‹œë‹ˆì–´ ê°œë°œì: [ì´ë¦„] ([ì´ë©”ì¼])
  - DevOps ì—”ì§€ë‹ˆì–´: [ì´ë¦„] ([ì´ë©”ì¼])

  14.2 ê¸°ìˆ  ì§€ì›

  - Slack ì±„ë„: #ptt-system-support
  - ì´ìŠˆ íŠ¸ë˜í‚¹: GitHub Issues
  - ë¬¸ì„œ ì—…ë°ì´íŠ¸: Confluence

  ---
  ğŸ“ ë¬¸ì„œ ë³€ê²½ ì´ë ¥

  | ë²„ì „   | ë‚ ì§œ         | ë³€ê²½ì‚¬í•­      | ì‘ì„±ì       |
  |------|------------|-----------|-----------|
  | v1.0 | 2025-01-17 | ì´ˆê¸° ê³„íšì„œ ì‘ì„± | Claude AI |

  ---
  ì´ ë¬¸ì„œëŠ” ì—…ê³„ ìµœê³  ìˆ˜ì¤€ì˜ PTT ì‹œìŠ¤í…œ êµ¬ì¶•ì„ ìœ„í•œ ì™„ì „í•œ ê°€ì´ë“œì…ë‹ˆë‹¤. ëª¨ë“  ê¸°ìˆ ì  ì„¸ë¶€ì‚¬í•­ê³¼
  êµ¬í˜„ ë°©ë²•ì´ í¬í•¨ë˜ì–´ ìˆì–´, ì´ëŒ€ë¡œ êµ¬í˜„í•˜ë©´ ê¸°ì‚¬ë“¤ì´ ì‚¬ë‘í•˜ëŠ” ì™„ë²½í•œ PTT ì‹œìŠ¤í…œì´ íƒ„ìƒí• 
  ê²ƒì…ë‹ˆë‹¤. ğŸ¯ğŸš€