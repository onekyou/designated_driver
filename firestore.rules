rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isAuthenticated() {
      return request.auth != null;
    }

    // Checks if the currently authenticated user's UID matches the provided userId
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Checks if the currently authenticated user is an admin of the specified office
    function isOfficeAdmin(regionId, officeId) {
      let adminPath = /databases/$(database)/documents/admins/$(request.auth.uid);
      return isAuthenticated()
             && exists(adminPath)
             && get(adminPath).data.associatedRegionId == regionId
             && get(adminPath).data.associatedOfficeId == officeId;
    }
    
    // Checks if the currently authenticated user is an admin (any office)
    function isAnyAdmin() {
      return isAuthenticated() && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    // --- Top-Level Collections ---

    match /admins/{adminId} { // adminId is the document ID, should be user's UID
      allow read, write: if isOwner(adminId);
      // ğŸ”¥ Firebase Functionsê°€ FCM í† í° ì¡°íšŒë¥¼ ìœ„í•´ ì½ê¸° ì ‘ê·¼ í—ˆìš©
      allow read: if request.auth == null; // Firebase Functions (ì„œë²„ ì‚¬ì´ë“œ)
    }

    match /pending_drivers/{userId} { // userId is the document ID, should be user's UID
      allow create: if isOwner(userId);
      allow read: if isAnyAdmin() || isOwner(userId);
      allow delete: if isAnyAdmin();
    }

    // --- Collection Group for Drivers to find their own document ---
    // â˜…â˜…â˜… ì¤‘ìš” ìˆ˜ì •: ê¸°ì‚¬ê°€ ë¡œê·¸ì¸ í›„ ìì‹ ì˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë„ë¡ ìˆ˜ì • â˜…â˜…â˜…
    // DriverViewModelì´ ì´ ê·œì¹™ì„ ì‚¬ìš©í•˜ì—¬ authUidë¡œ ê¸°ì‚¬ ë¬¸ì„œë¥¼ ì°¾ìŠµë‹ˆë‹¤.
    match /{path=**}/designated_drivers/{docId} { // docId is the document ID of the driver's record
      allow read: if isAuthenticated() && resource.data.authUid == request.auth.uid;
    }
    
    // (ì„ì‹œ ì „ì²´ í—ˆìš© ê·œì¹™ ì œê±°ë¨)

    // --- Nested Collections under Regions/Offices ---
    // ì§€ì—­(Document) ë° ì‚¬ë¬´ì‹¤(Document) ê¸°ë³¸ ì •ë³´ëŠ” ë¡œê·¸ì¸ ì—†ì´ ì½ê¸° í—ˆìš©
    match /regions/{regionId} {
      allow read: if true;

      match /offices/{officeId} {
        allow read: if true; // ì‚¬ë¬´ì‹¤ ì´ë¦„Â·ì„¤ì • ë“± ê¸°ë³¸ ì •ë³´

      match /designated_drivers/{driverDocId} {
        // ì½ê¸°(read): ê´€ë¦¬ìì´ê±°ë‚˜, ê¸°ì‚¬ ë³¸ì¸ì¸ ê²½ìš° í—ˆìš©
        allow read: if isOfficeAdmin(regionId, officeId) || (isAuthenticated() && resource.data.authUid == request.auth.uid);
        
        // ì“°ê¸°(write): ê´€ë¦¬ìì´ê±°ë‚˜, ê¸°ì‚¬ ë³¸ì¸ì¸ ê²½ìš° í—ˆìš©
        allow write: if isOfficeAdmin(regionId, officeId) || (isAuthenticated() && resource.data.authUid == request.auth.uid);
      }

      match /calls/{callId} {
        // í•´ë‹¹ ì‚¬ë¬´ì‹¤ì˜ ê´€ë¦¬ì ë˜ëŠ” ë°°ì •ëœ ê¸°ì‚¬(assignedDriverId í•„ë“œë¡œ í™•ì¸)ëŠ” íŠ¹ì • ì½œ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ê±°ë‚˜ ì¿¼ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        // getê³¼ list ê·œì¹™ì„ readë¡œ í†µí•©í•˜ì—¬ ê¶Œí•œ ì¶©ëŒ ë¬¸ì œë¥¼ í•´ê²°í•©ë‹ˆë‹¤.
        allow read: if
            isOfficeAdmin(regionId, officeId) ||
            (isAuthenticated() && resource.data.assignedDriverId == request.auth.uid);

        // ì½œ ìƒì„±: ëˆ„êµ¬ë‚˜ ì½œì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ì½œ ë””í…í„° ì•±ìš©).
        allow create: if true;

        // ì½œ ì‚­ì œ: ì‚¬ë¬´ì‹¤ ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.
        allow delete: if isOfficeAdmin(regionId, officeId);

        // ì½œ ì—…ë°ì´íŠ¸ (ìƒíƒœ ë¨¸ì‹ ):
        // ê´€ë¦¬ì ë˜ëŠ” ë°°ì •ëœ ê¸°ì‚¬ë§Œ ì—…ë°ì´íŠ¸ ê°€ëŠ¥
        allow update: if
          isOfficeAdmin(regionId, officeId) ||
          (
            // ì—…ë°ì´íŠ¸ ìš”ì²­ìê°€ í•´ë‹¹ ì½œì— ë°°ì •ëœ ê¸°ì‚¬ì¸ì§€ í™•ì¸
            isAuthenticated() && resource.data.assignedDriverId == request.auth.uid &&
            (
              // ìƒíƒœ ì „í™˜ ê·œì¹™ (í•„ìš”ì‹œ ê° ìƒíƒœë³„ í•„ë“œ ë³€ê²½ ê·œì¹™ ì¶”ê°€)
              (resource.data.status == "ASSIGNED" && request.resource.data.status == "ACCEPTED") ||
              (resource.data.status == "ACCEPTED" && request.resource.data.status == "IN_PROGRESS") ||
              (resource.data.status == "IN_PROGRESS" && request.resource.data.status == "AWAITING_SETTLEMENT") ||
              (resource.data.status == "AWAITING_SETTLEMENT" && request.resource.data.status == "COMPLETED")
            )
          );
      }

        // âœ… í¬ì¸íŠ¸(balance) ë¬¸ì„œ ê·œì¹™ â€“ ì˜¤ì§ ì‚¬ë¬´ì‹¤ ê´€ë¦¬ì ì½ê¸° ê°€ëŠ¥, ì„œë²„(Functions)ë§Œ ì“°ê¸°
        match /points/{pointsId} {
          allow read: if isOfficeAdmin(regionId, officeId);
          // Cloud Functions(ì„œë²„ ì‚¬ì´ë“œ)ë§Œ ì”ì•¡/ì¶©ì „ ë³€ê²½ í—ˆìš©
          allow write: if request.auth == null;
        }

        // ğŸ—‚ credits ì»¬ë ‰ì…˜ â€“ ê³ ê°ë³„ ì™¸ìƒ ì”ì•¡
        match /credits/{customerId} {
          // ì½ê¸°/ì“°ê¸°: ì‚¬ë¬´ì‹¤ ê´€ë¦¬ì, ë˜ëŠ” Cloud Functions (request.auth == null)
          allow read, write: if isOfficeAdmin(regionId, officeId) || request.auth == null;
        }

        // ğŸ—‚ settlements ì»¬ë ‰ì…˜ â€“ ì •ì‚° ë¬¸ì„œ
        match /settlements/{settlementId} {
          // ì½ê¸°: ì‚¬ë¬´ì‹¤ ê´€ë¦¬ì, í•´ë‹¹ ì½œì˜ ê¸°ì‚¬, ë˜ëŠ” ë‹¤ë¥¸ ì‚¬ë¬´ì‹¤ ê´€ë¦¬ì(ì „ì²´ ì—´ëŒ ê¶Œí•œ)
          allow read: if isOfficeAdmin(regionId, officeId) || isAnyAdmin() || (isAuthenticated() && resource.data.driverId == request.auth.uid);

          /* ì“°ê¸° ê·œì¹™
             - Cloud Functions: ìµœì´ˆ ìƒì„±(PENDING)Â·SETTLED ì²˜ë¦¬ì— ì‚¬ìš© â†’ request.auth == null
             - ì‚¬ë¬´ì‹¤ ê´€ë¦¬ì: settlementStatus ë¥¼ SETTLED ë¡œ ë³€ê²½í•  ë•Œë§Œ í—ˆìš©
          */
          // ê°„ì†Œí™”ëœ ì“°ê¸° ê·œì¹™: ì‚¬ë¬´ì‹¤ ê´€ë¦¬ìëŠ” ëª¨ë“  ì •ì‚° ì‘ì—… ê°€ëŠ¥
          allow write: if request.auth == null || isOfficeAdmin(regionId, officeId) || (
            // ë“œë¼ì´ë²„ê°€ ìì‹ ì˜ ì •ì‚°ì„ SETTLEDë¡œ ë³€ê²½ (ì™¸ìƒ/ì´ì²´ ì œì™¸)
            isAuthenticated() &&
            resource.data.driverId == request.auth.uid &&
            resource.data.settlementStatus == "PENDING" &&
            request.resource.data.settlementStatus == "SETTLED" &&
            resource.data.paymentMethod != "ì™¸ìƒ" &&
            resource.data.paymentMethod != "ì´ì²´"
          );
        }

        // ğŸ—“ dailySettlements ì»¬ë ‰ì…˜ â€“ ì—…ë¬´ ë§ˆê° ì§‘ê³„ ì¹´ë“œ
        match /dailySettlements/{dateId} {
          // ì½ê¸°: ì‚¬ë¬´ì‹¤ ê´€ë¦¬ìë§Œ
          allow read:  if isOfficeAdmin(regionId, officeId);

          // ì“°ê¸°: Cloud Functions(ì„œë²„) ë˜ëŠ” ì‚¬ë¬´ì‹¤ ê´€ë¦¬ì ë¡œì»¬ ì²˜ë¦¬(batch)
          allow write: if request.auth == null || isOfficeAdmin(regionId, officeId);

          // â”€â”€ sessions í•˜ìœ„ ì»¬ë ‰ì…˜: ë§ˆê° ë²„íŠ¼ë³„ ì„¸ì…˜ ì¹´ë“œ â”€â”€
          match /sessions/{sessionId} {
            allow read:  if isOfficeAdmin(regionId, officeId);
            allow write: if request.auth == null || isOfficeAdmin(regionId, officeId);
          }
        }

        // ğŸª™ point_transactions â€“ í¬ì¸íŠ¸ ê±°ë˜ ë‚´ì—­ (ì˜¤í”¼ìŠ¤ í•˜ìœ„ ì»¬ë ‰ì…˜)
        match /point_transactions/{txId} {
          // ì½ê¸°: í•´ë‹¹ ì‚¬ë¬´ì‹¤ ê´€ë¦¬ìë§Œ
          allow read: if isOfficeAdmin(regionId, officeId);
          // ì“°ê¸°: Cloud Functions(ì„œë²„) ì „ìš©
          allow write: if request.auth == null;
        }
      }
    }

    // ê³µìœ  ì½œ ê·œì¹™ â€“ OPEN â” CLAIMED 1íšŒë§Œ í—ˆìš©
    match /shared_calls/{sharedCallId} {
      // ê´€ë¦¬ìë¼ë©´ ì¡°íšŒ ê°€ëŠ¥
      allow read: if isAnyAdmin();

      // ê³µìœ  ì½œ ìƒì„±: ê´€ë¦¬ìë§Œ ê°€ëŠ¥ (source ì‚¬ë¬´ì‹¤)
      allow create: if isAnyAdmin();

      /*
       * OPEN ìƒíƒœì˜ ê³µìœ  ì½œì„ CLAIMED ìƒíƒœë¡œ ì „í™˜í•  ë•Œë§Œ í—ˆìš©
       *   â€“ resource.data.status      == "OPEN"  (í˜„ì¬)
       *   â€“ request.resource.data.status == "CLAIMED" (ìš”ì²­)
       *   â€“ ìµœì´ˆ í•œ ë²ˆë§Œ (claimedOfficeId ê°€ null â†’ ê°’ ì…ë ¥)
       */
      allow update: if
        isAnyAdmin() &&
        resource.data.status == "OPEN" &&
        request.resource.data.status == "CLAIMED" &&
        (
          !("claimedOfficeId" in resource.data) || resource.data.claimedOfficeId == null
        ) &&
        request.resource.data.claimedOfficeId != null;

      // í´ë¼ì´ì–¸íŠ¸ ì¸¡ ì‚­ì œ ê¸ˆì§€
      allow delete: if false;
    }

    // í¬ì¸íŠ¸ ê±°ë˜ ë‚´ì—­ â€“ ê´€ë¦¬ì ì½ê¸°, ì„œë²„(Function) ì“°ê¸° ì „ìš©
    match /point_transactions/{txId} {
      allow read: if isAnyAdmin();
      allow write: if request.auth == null;
    }
  }
}